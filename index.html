<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NBA Contract Database</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: white; }
  .container { max-width: 100%; margin: 0 auto; padding: 0.75rem 1rem; }

  header { text-align: center; padding: 1.25rem 0 0.75rem; }
  header h1 { font-size: 2rem; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .subtitle { color: #8892b0; font-size: 0.9rem; margin-top: 0.2rem; }
  .subtitle a { color: #667eea; text-decoration: none; }

  /* Controls bar */
  .controls { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-bottom: 0.75rem; padding: 0.6rem 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; }
  .search-box { flex: 1; min-width: 180px; padding: 0.45rem 0.75rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: white; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; outline: none; }
  .search-box::placeholder { color: #8892b0; }
  .search-box:focus { border-color: #667eea; background: rgba(255,255,255,0.12); }
  .filter-select { padding: 0.45rem 0.6rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: white; font-family: 'DM Sans', sans-serif; font-size: 0.8rem; cursor: pointer; outline: none; }
  .filter-select option { background: #1a1a2e; color: white; }
  .filter-select:focus { border-color: #667eea; }
  .result-count { color: #8892b0; font-size: 0.75rem; margin-left: auto; white-space: nowrap; }

  /* Loading */
  .loading { text-align: center; padding: 3rem; color: #8892b0; }
  .loading-spinner { width: 48px; height: 48px; border: 4px solid rgba(255,255,255,0.15); border-top-color: #667eea; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .error { text-align: center; padding: 2rem; color: #f87171; }

  /* Table wrapper */
  .table-wrap { background: rgba(255,255,255,0.95); border-radius: 12px; overflow: auto; box-shadow: 0 4px 24px rgba(0,0,0,0.3); max-height: calc(100vh - 200px); }

  /* Table */
  table { width: 100%; border-collapse: collapse; color: #1a1a2e; font-size: 0.75rem; }
  thead { position: sticky; top: 0; z-index: 20; }
  th { background: #1a1a2e; color: white; padding: 0.5rem 0.4rem; font-weight: 700; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.3px; white-space: nowrap; text-align: center; border-bottom: 3px solid #667eea; cursor: pointer; user-select: none; transition: background 0.15s; }
  th:hover { background: #2a2a5e; }
  th.sorted-asc::after { content: ' â–²'; font-size: 0.55rem; }
  th.sorted-desc::after { content: ' â–¼'; font-size: 0.55rem; }
  th.col-player { text-align: left; min-width: 150px; position: sticky; left: 0; z-index: 25; }
  th.col-team { text-align: left; min-width: 110px; position: sticky; left: 150px; z-index: 25; }
  th.yr-col { min-width: 85px; }
  th.yr-current { background: #2a2a5e; }
  th.meta-col { background: #1e2d3d; }

  td { padding: 0.35rem 0.4rem; text-align: center; border-bottom: 1px solid #eef0f6; vertical-align: middle; white-space: nowrap; }
  tr:hover td { background: #f0f1ff !important; }

  /* Sticky column backgrounds */
  td.col-player, td.col-team { position: sticky; z-index: 5; }
  td.col-player { left: 0; }
  td.col-team { left: 150px; }
  tr:nth-child(odd) td { background: #fff; }
  tr:nth-child(even) td { background: #f8f9ff; }

  /* Player cell */
  .pc { display: flex; align-items: center; gap: 0.4rem; }
  .pc-hs { width: 30px; height: 22px; border-radius: 3px; background: linear-gradient(135deg, #667eea, #764ba2); overflow: hidden; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
  .pc-hs img { width: 100%; height: 100%; object-fit: cover; }
  .pc-hs .ini { color: white; font-weight: 700; font-size: 0.5rem; }
  .pc-nm { font-weight: 700; font-size: 0.8rem; }

  /* Team cell */
  .tm { display: flex; align-items: center; gap: 0.35rem; }
  .tm img { width: 20px; height: 20px; }
  .tm span { font-weight: 600; font-size: 0.75rem; }

  /* Salary cells */
  .sc { display: inline-block; border-radius: 3px; padding: 0.15rem 0.3rem; font-weight: 600; font-size: 0.7rem; min-width: 62px; text-align: right; }
  .sc.g { background: #e8f5e9; color: #2e7d32; }
  .sc.pg { background: #fff8e1; color: #f57f17; background-image: repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(245,127,23,0.06) 2px, rgba(245,127,23,0.06) 4px); }
  .sc.ng { background: #fce4ec; color: #c62828; border: 1px dashed #ef9a9a; }
  .sc.to { background: #e3f2fd; color: #1565c0; }
  .sc.po { background: #f3e5f5; color: #7b1fa2; }
  .sc.tw { background: #e0e0e0; color: #616161; font-size: 0.6rem; }
  .sc.td { background: #fff3e0; color: #e65100; font-size: 0.6rem; }
  .empty { color: #d0d0d0; }
  .guar-line { display: block; font-size: 0.55rem; margin-top: 2px; font-weight: 600; white-space: nowrap; }
  .guar-line.partial { color: #f57f17; }
  .guar-line.non-g { color: #c62828; }
  .end-ch { display: block; font-size: 0.55rem; color: #667eea; font-weight: 600; margin-top: 2px; white-space: nowrap; }

  /* End column scenario cells */
  .end-scenarios { display: flex; gap: 3px; align-items: flex-start; }
  .end-scenario { padding: 2px 5px; border-radius: 3px; border: 1px solid #333; background: #1a1a2e; text-align: center; min-width: 38px; }
  .end-scenario.sc-first { border-color: #c62828; background: rgba(198,40,40,0.08); }
  .end-scenario.sc-last { border-color: #2e7d32; background: rgba(46,125,50,0.08); }
  .end-scenario.sc-mid { border-color: #f57f17; background: rgba(245,127,23,0.08); }
  .end-sc-label { display: block; font-size: 0.45rem; font-weight: 600; color: #999; text-transform: uppercase; letter-spacing: 0.3px; line-height: 1.1; }
  .end-sc-year { display: block; font-weight: 700; font-size: 0.7rem; line-height: 1.2; }

  /* Tags */
  .tag { display: inline-block; padding: 0.1rem 0.35rem; border-radius: 3px; font-size: 0.6rem; font-weight: 600; max-width: 140px; overflow: hidden; text-overflow: ellipsis; }
  .tag-exc { background: #e8eaf6; color: #3949ab; }
  .tag-type { background: #f3e5f5; color: #7b1fa2; }
  .tag-opt-to { background: #e3f2fd; color: #1565c0; }
  .tag-opt-po { background: #f3e5f5; color: #7b1fa2; }
  .tag-tk { background: #fff3e0; color: #e65100; }
  .tag-ext-elig { background: #e8f5e9; color: #2e7d32; }
  .tag-ext-date { background: #e3f2fd; color: #1565c0; }
  .tag-ext-inelig { background: #fce4ec; color: #c62828; }
  .tag-ext-rookie { background: #f3e5f5; color: #7b1fa2; }
  .tag-ext-done { background: #e0e0e0; color: #616161; }
  .tag-ext-na { background: transparent; color: #bbb; }
  .ext-note { font-size: 0.55rem; color: #999; display: block; margin-top: 1px; }
  td.meta-val { font-size: 0.7rem; color: #5c6370; }

  /* Legend */
  .legend { display: flex; flex-wrap: wrap; gap: 0.4rem 0.75rem; margin-bottom: 0.5rem; padding: 0.4rem 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; }
  .legend-item { display: flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; color: #c0c8e0; }
  .legend-sw { width: 12px; height: 12px; border-radius: 2px; flex-shrink: 0; }

  footer { text-align: center; margin-top: 1.5rem; padding: 0.75rem; color: #8892b0; font-size: 0.8rem; }
  footer a { color: #667eea; text-decoration: none; }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>ðŸ“‹ NBA Contract Database</h1>
    <p class="subtitle">Powered by <a href="https://hoopsmatic.com" target="_blank">HoopsMatic</a></p>
  </header>

  <div id="controls" class="controls" style="display:none;">
    <input type="text" class="search-box" id="searchBox" placeholder="Search player or team...">
    <select class="filter-select" id="filterTeam"><option value="">All Teams</option></select>
    <select class="filter-select" id="filterStatus">
      <option value="">All Statuses</option>
      <option value="GUARANTEED">Guaranteed</option>
      <option value="PARTIAL G">Partial G</option>
      <option value="NOT G">Non-Guaranteed</option>
      <option value="TEAM OPT">Team Option</option>
      <option value="PLAYER OPT">Player Option</option>
      <option value="TWO-WAY">Two-Way</option>
      <option value="10-DAY">10-Day</option>
    </select>
    <select class="filter-select" id="filterException">
      <option value="">All Exceptions</option>
      <option value="Bird Exception">Bird</option>
      <option value="Early Bird Exception">Early Bird</option>
      <option value="Non-Bird Exception">Non-Bird</option>
      <option value="Mid-Level Exception">MLE</option>
      <option value="Taxpayer Mid-Level Exception">Taxpayer MLE</option>
      <option value="Room Mid-Level Exception">Room MLE</option>
      <option value="Biannual Exception">BAE</option>
      <option value="Minimum Salary Exception">Minimum</option>
      <option value="Rookie Exception">Rookie</option>
      <option value="Second Round Exception">2nd Round</option>
    </select>
    <select class="filter-select" id="filterEnd">
      <option value="">All End Years</option>
      <option value="2026">2026</option>
      <option value="2027">2027</option>
      <option value="2028">2028</option>
      <option value="2029">2029</option>
      <option value="2030">2030</option>
      <option value="2031">2031</option>
    </select>
    <select class="filter-select" id="filterExt">
      <option value="">Extension Elig.</option>
      <option value="eligible">Eligible Now</option>
      <option value="future">Future Date</option>
      <option value="ineligible">Ineligible (1-2yr)</option>
      <option value="rookie">Rookie Scale</option>
    </select>
    <span class="result-count" id="resultCount"></span>
  </div>

  <div class="legend" id="legend" style="display:none;">
    <div class="legend-item"><div class="legend-sw" style="background:#e8f5e9;border:1px solid #a5d6a7;"></div>Guaranteed</div>
    <div class="legend-item"><div class="legend-sw" style="background:repeating-linear-gradient(45deg,#fff8e1,#fff8e1 2px,#fff0b3 2px,#fff0b3 4px);border:1px solid #ffe082;"></div>Partial G</div>
    <div class="legend-item"><div class="legend-sw" style="background:#fce4ec;border:1px dashed #ef9a9a;"></div>Non-G</div>
    <div class="legend-item"><div class="legend-sw" style="background:#e3f2fd;border:1px solid #90caf9;"></div>Team Opt</div>
    <div class="legend-item"><div class="legend-sw" style="background:#f3e5f5;border:1px solid #ce93d8;"></div>Player Opt</div>
    <div class="legend-item"><div class="legend-sw" style="background:#e0e0e0;border:1px solid #bdbdbd;"></div>Two-Way</div>
    <div class="legend-item"><div class="legend-sw" style="background:#fff3e0;border:1px solid #ffcc80;"></div>10-Day</div>
    <div class="legend-item" style="margin-left:auto;color:#8892b0;font-size:0.65rem;">Dotted underline = cap hold differs (hover for value)</div>
  </div>

  <div id="loading" class="loading"><div class="loading-spinner"></div><p>Loading contract data...</p></div>
  <div id="tableArea" style="display:none;"></div>
  <div id="error" class="error" style="display:none;"></div>

  <footer>Data compiled by <a href="https://hoopsmatic.com" target="_blank">HoopsMatic</a> Â· <a href="https://aderoa.github.io/DepthCharts/" target="_blank">Depth Charts</a> Â· <a href="https://aderoa.github.io/Injuries/" target="_blank">Injury Report</a></footer>
</div>

<script>
const SHEET_ID = '2PACX-1vSg6im6IYB6HXMGzQbmmBnLw9SfQLzxCSo8OfChxlJLhsB6BBCO0wPF_TMch0YgAbtFqYkwDWrsxRe7';
const CONTRACT_GID = '1649473047';
const CSV_URL = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?gid=${CONTRACT_GID}&single=true&output=csv`;
const ROSTER_CSV_URL = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?gid=0&single=true&output=csv`;

const TEAM_IDS = {
  'Atlanta':1610612737,'Boston':1610612738,'Brooklyn':1610612751,
  'Charlotte':1610612766,'Chicago':1610612741,'Cleveland':1610612739,
  'Dallas':1610612742,'Denver':1610612743,'Detroit':1610612765,
  'Golden State':1610612744,'Houston':1610612745,'Indiana':1610612754,
  'LA Clippers':1610612746,'LA Lakers':1610612747,'Memphis':1610612763,
  'Miami':1610612748,'Milwaukee':1610612749,'Minnesota':1610612750,
  'New Orleans':1610612740,'New York':1610612752,'Oklahoma City':1610612760,
  'Orlando':1610612753,'Philadelphia':1610612755,'Phoenix':1610612756,
  'Portland':1610612757,'Sacramento':1610612758,'San Antonio':1610612759,
  'Toronto':1610612761,'Utah':1610612762,'Washington':1610612764
};

function teamLogo(t) { const id = TEAM_IDS[t]; return id ? `https://cdn.nba.com/logos/nba/${id}/primary/L/logo.svg` : ''; }
function ini(n) { return n.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase(); }

const YEARS = [
  { label: "'25-26", sc: 7, cc: 8, tc: 9, current: true },
  { label: "'26-27", sc: 10, cc: 11, tc: 12 },
  { label: "'27-28", sc: 13, cc: 14, tc: 15 },
  { label: "'28-29", sc: 16, cc: 17, tc: 18 },
  { label: "'29-30", sc: 19, cc: 20, tc: 21 },
  { label: "'30-31", sc: 22, cc: 23, tc: 24 },
];

let allPlayers = [];
let filteredPlayers = [];
let headshots = {};
let sortCol = 'sal0';
let sortDir = 'desc';

function parseCSV(text) {
  const rows = []; let cur = '', inQ = false, row = [];
  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (c === '"') { if (inQ && text[i+1] === '"') { cur += '"'; i++; } else inQ = !inQ; }
    else if (c === ',' && !inQ) { row.push(cur); cur = ''; }
    else if ((c === '\n' || c === '\r') && !inQ) {
      if (c === '\r' && text[i+1] === '\n') i++;
      row.push(cur); cur = '';
      if (row.some(v => v.trim())) rows.push(row);
      row = [];
    } else cur += c;
  }
  row.push(cur);
  if (row.some(v => v.trim())) rows.push(row);
  return rows;
}

function parseSal(v) {
  const s = (v||'').trim().replace(/[$,]/g, '');
  return s && /^\d+$/.test(s) ? parseInt(s) : 0;
}

function normSt(v) {
  const s = (v||'').trim().toUpperCase();
  if (s.startsWith('GUAR') || s === 'GIUARANTEED' || s === 'GUARANTEEED') return 'GUARANTEED';
  if (s === 'PARTIAL G') return 'PARTIAL G';
  if (s === 'NOT G') return 'NOT G';
  if (s === 'TEAM OPT') return 'TEAM OPT';
  if (s === 'PLAYER OPT') return 'PLAYER OPT';
  if (s === 'TWO-WAY') return 'TWO-WAY';
  if (s === '10-DAY') return '10-DAY';
  return s;
}

function fmtS(n) {
  if (!n) return '';
  if (n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
  if (n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
  return '$' + n.toLocaleString();
}
function fmtFull(n) { return n ? '$' + n.toLocaleString() : ''; }

// =====================================================
// CAP HOLD CALCULATIONS
// =====================================================
const AVG_SAL_2526 = 13870000;
const AVG_GROWTH = 1.073412352001655;
// Cap hold for minimum salary players = 2-yr vet minimum (non-reimbursed portion)
const MIN_CH_2627 = 2464849;  // projected 2026-27
// Cap hold for two-way players = 1 YOS minimum
const TWOWAY_CH_2526 = 2048494; // 1 YOS minimum 2025-26
function avgSalForYear(yi) { return Math.round(AVG_SAL_2526 * Math.pow(AVG_GROWTH, yi)); }
function minCapHoldForYear(yi) { return yi <= 0 ? Math.round(MIN_CH_2627 / AVG_GROWTH) : Math.round(MIN_CH_2627 * Math.pow(AVG_GROWTH, yi - 1)); }
function twowayCapHoldForYear(yi) { return Math.round(TWOWAY_CH_2526 * Math.pow(AVG_GROWTH, yi)); }

function calcCapHold(prevSal, p, yearIndex, endYearOverride) {
  const e = (p.exc || '').toLowerCase();
  const notes_lc = (p.notes || '').toLowerCase();
  const isTwoWay = notes_lc.includes('two-way') || p.yrs.some(y => y.st === 'TWO-WAY');
  const isMinimum = e.includes('minimum') || e.includes('two-way');

  // Two-Way â†’ 1 YOS minimum cap hold
  if (isTwoWay) {
    return { hold: twowayCapHoldForYear(yearIndex), rights: 'Two-Way (1 YOS min)' };
  }
  // Minimum salary â†’ 2-yr vet minimum cap hold (CBA 4(d)(4))
  if (isMinimum) {
    return { hold: minCapHoldForYear(yearIndex), rights: 'Minimum (2 YOS min)' };
  }
  // Rookie Scale Contracts only (first-round picks) â†’ 300%/250%
  if (e.includes('rookie') && !e.includes('second')) {
    const avg = avgSalForYear(yearIndex);
    const pct = prevSal < avg ? 3.0 : 2.5;
    return { hold: Math.round(prevSal * pct), rights: `Rookie Scale (${pct*100}%)` };
  }

  // Derive contract length from signing date + effective end year
  const effectiveEnd = endYearOverride || parseInt(p.end);
  let contractLen = null;
  if (p.sigDate && effectiveEnd) {
    const parts = p.sigDate.split('/');
    if (parts.length === 3) {
      const sigMonth = parseInt(parts[0]), sigYear = parseInt(parts[2]);
      const firstSeasonEnd = sigMonth >= 7 ? sigYear + 1 : sigYear;
      if (!isNaN(firstSeasonEnd) && !isNaN(effectiveEnd)) contractLen = effectiveEnd - firstSeasonEnd + 1;
    }
  }

  // Determine Bird rights combining exception + contract length
  let totalService;
  if (e.includes('bird') && !e.includes('early') && !e.includes('non-bird')) {
    totalService = 99;
  } else if (e.includes('early bird')) {
    totalService = 2 + (contractLen || 0);
  } else if (e.includes('non-bird')) {
    totalService = 1 + (contractLen || 0);
  } else {
    totalService = contractLen;
  }

  if (totalService === null) return null;

  const avg = avgSalForYear(yearIndex);
  let pct, rights;
  if (totalService >= 3) {
    pct = prevSal < avg ? 1.9 : 1.5;
    rights = `Full Bird (${Math.round(pct*100)}%)`;
  } else if (totalService >= 2) {
    pct = 1.3;
    rights = 'Early Bird (130%)';
  } else {
    pct = 1.2;
    rights = 'Non-Bird (120%)';
  }

  return { hold: Math.round(prevSal * pct), rights };
}

// Build end-year scenarios based on option years
function getEndScenarios(p) {
  const endYear = parseInt(p.end);
  if (!endYear) return [];

  // Find option year indices (sorted)
  const optYears = [];
  for (let i = 0; i < YEARS.length; i++) {
    const st = p.yrs[i].st;
    if (st === 'TEAM OPT' || st === 'PLAYER OPT') {
      optYears.push({ idx: i, type: st });
    }
  }

  if (optYears.length === 0) {
    return [{ endYr: endYear, label: null, cls: '' }];
  }

  const scenarios = [];
  const isTO = (t) => t === 'TEAM OPT';

  if (optYears.length === 1) {
    const opt = optYears[0];
    const declinedEnd = 2025 + opt.idx;
    const tag = isTO(opt.type) ? 'TO' : 'PO';
    scenarios.push({ endYr: declinedEnd, label: `${tag} âœ—`, cls: 'sc-first' });
    scenarios.push({ endYr: endYear, label: `${tag} âœ“`, cls: 'sc-last' });
  } else {
    for (let o = 0; o < optYears.length; o++) {
      const opt = optYears[o];
      const declinedEnd = 2025 + opt.idx;
      const tag = isTO(opt.type) ? 'TO' : 'PO';
      const cls = o === 0 ? 'sc-first' : 'sc-mid';
      scenarios.push({ endYr: declinedEnd, label: `${tag}${o+1} âœ—`, cls });
    }
    scenarios.push({ endYr: endYear, label: 'All âœ“', cls: 'sc-last' });
  }

  return scenarios;
}

// =====================================================
// EXTENSION ELIGIBILITY
// =====================================================
function calcExtElig(p) {
  // No team = free agent
  if (!p.team) return { status: 'na', text: 'Free Agent', sortVal: 9 };

  // Two-Way / 10-Day
  const notes_lc = (p.notes||'').toLowerCase();
  if (notes_lc.includes('two-way') || p.yrs.every(y => y.st === 'TWO-WAY' || !y.st))
    return { status: 'na', text: 'N/A', detail: 'Two-Way', sortVal: 8 };
  if (notes_lc.includes('10-day') || p.yrs.every(y => y.st === '10-DAY' || !y.st))
    return { status: 'na', text: 'N/A', detail: '10-Day', sortVal: 8 };

  // Already extended â€” calculate next eligibility from the extension signing date
  if (notes_lc.includes('extension')) {
    if (!p.sigDate || !p.end) return { status: 'extended', text: 'Extended', detail: p.notes, sortVal: 6 };

    const parts = p.sigDate.split('/');
    if (parts.length !== 3) return { status: 'extended', text: 'Extended', detail: p.notes, sortVal: 6 };
    let eMonth = parseInt(parts[0]), eDay = parseInt(parts[1]), eYear = parseInt(parts[2]);
    if (isNaN(eMonth) || isNaN(eDay) || isNaN(eYear)) return { status: 'extended', text: 'Extended', detail: p.notes, sortVal: 6 };

    // Oct 1 rule
    if (eMonth === 10 && eDay >= 2) eDay = 1;

    const eFirstEnd = eMonth >= 7 ? eYear + 1 : eYear;
    const eEndYear = parseInt(p.end);
    if (isNaN(eEndYear)) return { status: 'extended', text: 'Extended', detail: p.notes, sortVal: 6 };
    const eTotalLen = eEndYear - eFirstEnd + 1;

    // Extension resulted in 1-2 years total â€” shouldn't happen, but handle it
    if (eTotalLen <= 2) return { status: 'extended', text: 'Extended', detail: `${p.notes} Â· ${eTotalLen}-yr total, next ext. ineligible`, sortVal: 6 };

    const eWait = eTotalLen <= 4 ? 2 : 3;
    const eAnniv = new Date(eYear + eWait, eMonth - 1, eDay);
    const today = new Date(); today.setHours(0,0,0,0);
    const eFmt = eAnniv.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    const traded = p.sigTeam && p.team && p.sigTeam !== p.team;

    if (eAnniv <= today) {
      return {
        status: 'eligible', text: 'Eligible',
        detail: `Extended (${p.notes}) Â· Re-eligible since ${eFmt}` + (traded ? ' Â· Trade restriction may apply' : ''),
        sortVal: 1, dateVal: eAnniv.getTime()
      };
    } else {
      return {
        status: 'future', text: eFmt,
        detail: `Extended (${p.notes}) Â· ${eTotalLen}-yr total, ${eWait === 2 ? '2nd' : '3rd'} anniv.` + (traded ? ' Â· Trade restriction may apply' : ''),
        sortVal: 2, dateVal: eAnniv.getTime()
      };
    }
  }

  // Rookie Scale Contract â€” different rules (eligible between 3rd-4th year)
  if (notes_lc.includes('rookie scale')) {
    return { status: 'rookie', text: 'Rookie Scale', detail: 'Different rules apply', sortVal: 5 };
  }

  // No signing date â†’ unknown
  if (!p.sigDate || !p.end) return { status: 'unknown', text: 'â€”', sortVal: 10 };

  // Parse signing date (M/D/YYYY)
  const parts = p.sigDate.split('/');
  if (parts.length !== 3) return { status: 'unknown', text: 'â€”', sortVal: 10 };
  let sigMonth = parseInt(parts[0]);
  let sigDay = parseInt(parts[1]);
  const sigYear = parseInt(parts[2]);
  if (isNaN(sigMonth) || isNaN(sigDay) || isNaN(sigYear)) return { status: 'unknown', text: 'â€”', sortVal: 10 };

  // Oct 1 rule: signings Oct 2 through end of Oct count as Oct 1 for anniversary
  if (sigMonth === 10 && sigDay >= 2) { sigDay = 1; }

  // First NBA season "end year": signed Jul+ â†’ year+1, signed Jan-Jun â†’ year
  const firstSeasonEnd = sigMonth >= 7 ? sigYear + 1 : sigYear;

  // Contract length
  const endYear = parseInt(p.end);
  if (isNaN(endYear)) return { status: 'unknown', text: 'â€”', sortVal: 10 };
  const length = endYear - firstSeasonEnd + 1;

  // 1-2 year deals cannot be extended
  if (length <= 2) return { status: 'ineligible', text: 'Ineligible', detail: `${length}-year deal`, sortVal: 7 };

  // Waiting period: 3-4yr â†’ 2nd anniversary, 5-6yr â†’ 3rd anniversary
  const waitYears = length <= 4 ? 2 : 3;

  // Anniversary date
  const annivDate = new Date(sigYear + waitYears, sigMonth - 1, sigDay);

  // Compare to today
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // Format the date
  const fmtDate = annivDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

  // Traded player caveat: 6-month post-trade restriction may apply
  const traded = p.sigTeam && p.team && p.sigTeam !== p.team;

  if (annivDate <= today) {
    return {
      status: 'eligible', text: 'Eligible',
      detail: `Since ${fmtDate}` + (traded ? ' Â· Trade restriction may apply' : ''),
      sortVal: 1, dateVal: annivDate.getTime()
    };
  } else {
    return {
      status: 'future', text: fmtDate,
      detail: `${length}-year deal, ${waitYears === 2 ? '2nd' : '3rd'} anniv.` + (traded ? ' Â· Trade restriction may apply' : ''),
      sortVal: 2, dateVal: annivDate.getTime()
    };
  }
}

async function loadData() {
  try {
    const csvR = await fetch(CSV_URL);
    if (!csvR.ok) throw new Error('CSV fetch failed');
    const rows = parseCSV(await csvR.text());
    if (rows.length < 2) throw new Error('No data');

    allPlayers = [];
    for (let i = 1; i < rows.length; i++) {
      const r = rows[i];
      const name = (r[0]||'').trim();
      if (!name) continue;
      const team = (r[2]||'').trim() || null;
      const yrs = YEARS.map(yr => ({ sal: parseSal(r[yr.sc]), ch: parseSal(r[yr.cc]), st: normSt(r[yr.tc]) }));

      allPlayers.push({
        name, team, yrs,
        sal2425: parseSal(r[4]),
        totG: parseSal(r[28]), totGCur: parseSal(r[25]),
        option: (r[26]||'').trim(), end: (r[27]||'').trim(),
        sigDate: (r[29]||'').trim(), sigTeam: (r[30]||'').trim(),
        exc: (r[31]||'').trim(), notes: (r[32]||'').trim(),
        tk: (r[33]||'').trim(), lb: (r[34]||'').trim(), ub: (r[35]||'').trim(),
      });
    }

    // Compute extension eligibility for all players
    allPlayers.forEach(p => { p.ext = calcExtElig(p); });

    // Remove free agents (no current team)
    allPlayers = allPlayers.filter(p => p.team);

    // Headshots
    try {
      const rR = await fetch(ROSTER_CSV_URL);
      if (rR.ok) {
        const rRows = parseCSV(await rR.text());
        if (rRows.length > 1) {
          const hdr = rRows[0];
          const pi = hdr.findIndex(h => h.toUpperCase() === 'PLAYER');
          const hi = hdr.findIndex(h => h.toUpperCase() === 'HEADSHOT');
          if (pi >= 0 && hi >= 0) {
            for (let j = 1; j < rRows.length; j++) {
              const n = (rRows[j][pi]||'').trim();
              const hs = (rRows[j][hi]||'').trim();
              if (n && hs) headshots[n] = hs;
            }
          }
        }
      }
    } catch(e) {}

    // Populate team filter
    const teams = [...new Set(allPlayers.filter(p=>p.team).map(p=>p.team))].sort();
    const sel = document.getElementById('filterTeam');
    teams.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; sel.appendChild(o); });

    document.getElementById('loading').style.display = 'none';
    document.getElementById('controls').style.display = 'flex';
    document.getElementById('legend').style.display = 'flex';
    document.getElementById('tableArea').style.display = 'block';
    applyFilters();

  } catch(err) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').textContent = 'Failed to load: ' + err.message;
    document.getElementById('error').style.display = 'block';
  }
}

function applyFilters() {
  const q = document.getElementById('searchBox').value.toLowerCase().trim();
  const fTeam = document.getElementById('filterTeam').value;
  const fSt = document.getElementById('filterStatus').value;
  const fExc = document.getElementById('filterException').value;
  const fEnd = document.getElementById('filterEnd').value;
  const fExt = document.getElementById('filterExt').value;

  filteredPlayers = allPlayers.filter(p => {
    if (q && !p.name.toLowerCase().includes(q) && !(p.team||'').toLowerCase().includes(q) && !(p.notes||'').toLowerCase().includes(q)) return false;
    if (fTeam && p.team !== fTeam) return false;
    if (fSt && !p.yrs.some(y => y.st === fSt)) return false;
    if (fExc && p.exc !== fExc) return false;
    if (fEnd && p.end !== fEnd) return false;
    if (fExt && p.ext.status !== fExt) return false;
    return true;
  });

  doSort();
  renderTable();
  document.getElementById('resultCount').textContent = `${filteredPlayers.length} of ${allPlayers.length} contracts`;
}

function doSort() {
  filteredPlayers.sort((a, b) => {
    let va, vb;
    if (sortCol === 'name') { va = a.name; vb = b.name; }
    else if (sortCol === 'team') { va = a.team || 'zzz'; vb = b.team || 'zzz'; }
    else if (sortCol === 'end') { va = a.end || ''; vb = b.end || ''; }
    else if (sortCol === 'totG') { va = a.totG; vb = b.totG; }
    else if (sortCol === 'exc') { va = a.exc; vb = b.exc; }
    else if (sortCol === 'notes') { va = a.notes; vb = b.notes; }
    else if (sortCol === 'sigDate') {
      va = a.sigDate ? new Date(a.sigDate).getTime() || 0 : 0;
      vb = b.sigDate ? new Date(b.sigDate).getTime() || 0 : 0;
    }
    else if (sortCol === 'sigTeam') { va = a.sigTeam; vb = b.sigTeam; }
    else if (sortCol === 'option') { va = a.option; vb = b.option; }
    else if (sortCol === 'tk') { va = parseFloat(a.tk) || 0; vb = parseFloat(b.tk) || 0; }
    else if (sortCol === 'ext') {
      // Sort by status priority first, then by date for eligible/future
      va = a.ext.sortVal * 1e15 + (a.ext.dateVal || 0);
      vb = b.ext.sortVal * 1e15 + (b.ext.dateVal || 0);
    }
    else if (sortCol.startsWith('sal')) {
      const yi = parseInt(sortCol.slice(3));
      va = a.yrs[yi]?.sal || 0; vb = b.yrs[yi]?.sal || 0;
    } else { va = 0; vb = 0; }

    if (typeof va === 'string') {
      const c = va.localeCompare(vb);
      return sortDir === 'asc' ? c : -c;
    }
    return sortDir === 'asc' ? va - vb : vb - va;
  });
}

function setSort(col) {
  if (sortCol === col) { sortDir = sortDir === 'asc' ? 'desc' : 'asc'; }
  else { sortCol = col; sortDir = (col === 'name' || col === 'team' || col === 'exc' || col === 'notes' || col === 'sigTeam' || col === 'ext') ? 'asc' : 'desc'; }
  applyFilters();
}

function renderTable() {
  const area = document.getElementById('tableArea');
  let html = '<div class="table-wrap"><table><thead><tr>';

  html += thS('Player', 'name', 'col-player');
  html += thS('Team', 'team', 'col-team');
  YEARS.forEach((yr, i) => { html += thS(yr.label, 'sal' + i, 'yr-col' + (yr.current ? ' yr-current' : '')); });
  html += thS('End', 'end', 'meta-col');
  html += thS('Option', 'option', 'meta-col');
  html += thS('Total G', 'totG', 'meta-col');
  html += thS('Exception', 'exc', 'meta-col');
  html += thS('Type / Notes', 'notes', 'meta-col');
  html += thS('Signed', 'sigDate', 'meta-col');
  html += thS('Sign. Team', 'sigTeam', 'meta-col');
  html += thS('TK', 'tk', 'meta-col');
  html += thS('Ext. Eligible', 'ext', 'meta-col');
  html += '</tr></thead><tbody>';

  for (const p of filteredPlayers) {
    html += '<tr>';

    // Player
    const hs = headshots[p.name];
    const hsH = hs
      ? `<div class="pc-hs"><img src="${hs}" onerror="this.parentElement.innerHTML='<span class=\\'ini\\'>${ini(p.name)}</span>'"></div>`
      : `<div class="pc-hs"><span class="ini">${ini(p.name)}</span></div>`;
    html += `<td class="col-player"><div class="pc">${hsH}<span class="pc-nm">${p.name}</span></div></td>`;

    // Team
    html += `<td class="col-team"><div class="tm"><img src="${teamLogo(p.team)}" alt=""><span>${p.team}</span></div></td>`;

    // Year cells
    for (let i = 0; i < YEARS.length; i++) { html += '<td>' + salCell(p, i) + '</td>'; }

    // End + Cap Hold scenarios
    const scenarios = getEndScenarios(p);
    let endHtml = '';
    const isTW = (p.notes||'').toLowerCase().includes('two-way') || p.yrs.some(y => y.st === 'TWO-WAY');
    const isMin = (p.exc||'').toLowerCase().includes('minimum');

    if (scenarios.length <= 1) {
      // No options â€” single end year
      const sc = scenarios[0];
      const ey = sc ? sc.endYr : parseInt(p.end);
      endHtml = `<span style="font-weight:700;font-size:0.75rem;">${ey || p.end || ''}</span>`;
      if (ey) {
        const lastYrIdx = ey - 2026;
        const lastSal = lastYrIdx >= 0 && lastYrIdx < YEARS.length ? (p.yrs[lastYrIdx]?.sal || 0) : 0;
        const chYrIdx = ey - 2025;
        if (lastSal || isTW || isMin) {
          const ch = calcCapHold(lastSal, p, chYrIdx, ey);
          if (ch !== null) {
            endHtml += `<span class="end-ch" title="${ch.rights} Â· Projected cap hold: ${fmtFull(ch.hold)}">Cap Hold: ${fmtS(ch.hold)}</span>`;
          }
        }
      }
    } else {
      // Multiple scenarios
      endHtml = '<div class="end-scenarios">';
      for (const sc of scenarios) {
        const ey = sc.endYr;
        const lastYrIdx = ey - 2026;
        const lastSal = lastYrIdx >= 0 && lastYrIdx < YEARS.length ? (p.yrs[lastYrIdx]?.sal || 0) : 0;
        const chYrIdx = ey - 2025;
        let chHtml = '';
        if (lastSal || isTW || isMin) {
          const ch = calcCapHold(lastSal, p, chYrIdx, ey);
          if (ch !== null) {
            chHtml = `<span class="end-ch" title="${ch.rights} Â· Projected cap hold: ${fmtFull(ch.hold)}">CH: ${fmtS(ch.hold)}</span>`;
          }
        }
        endHtml += `<div class="end-scenario ${sc.cls}">`;
        endHtml += `<span class="end-sc-label">${sc.label}</span>`;
        endHtml += `<span class="end-sc-year">${ey}</span>`;
        endHtml += chHtml;
        endHtml += `</div>`;
      }
      endHtml += '</div>';
    }
    html += `<td>${endHtml}</td>`;

    // Option
    html += '<td>' + optTag(p.option) + '</td>';

    // Total Guaranteed
    html += `<td style="font-weight:700;font-size:0.75rem;">${fmtS(p.totG)}</td>`;

    // Exception
    html += `<td>${p.exc ? `<span class="tag tag-exc" title="${p.exc}">${shortExc(p.exc)}</span>` : ''}</td>`;

    // Notes
    html += `<td>${p.notes ? `<span class="tag tag-type" title="${p.notes}">${shortNotes(p.notes)}</span>` : ''}</td>`;

    // Signing date
    html += `<td class="meta-val">${p.sigDate || ''}</td>`;

    // Signing team (highlight if different from current)
    const traded = p.sigTeam && p.team && p.sigTeam !== p.team;
    html += `<td class="meta-val"${traded ? ' style="color:#e65100;font-weight:600;"' : ''}>${p.sigTeam || ''}</td>`;

    // Trade Kicker
    html += `<td>${p.tk ? `<span class="tag tag-tk">${p.tk}</span>` : ''}</td>`;

    // Extension Eligibility
    html += '<td>' + extTag(p.ext) + '</td>';

    html += '</tr>';
  }

  html += '</tbody></table></div>';
  area.innerHTML = html;
}

function thS(label, col, cls) {
  const sc = sortCol === col ? (sortDir === 'asc' ? ' sorted-asc' : ' sorted-desc') : '';
  return `<th class="${cls || ''}${sc}" onclick="setSort('${col}')">${label}</th>`;
}

function salCell(p, yi) {
  const y = p.yrs[yi];
  if (!y || (!y.sal && !y.st)) return '<span class="empty">â€”</span>';

  const cls = { 'GUARANTEED':'g','PARTIAL G':'pg','NOT G':'ng','TEAM OPT':'to','PLAYER OPT':'po','TWO-WAY':'tw','10-DAY':'td' }[y.st] || 'g';
  let html = `<span class="sc ${cls}">${fmtS(y.sal)}</span>`;

  // Show guaranteed portion inline for PARTIAL G and NOT G
  if (y.st === 'PARTIAL G' && y.ch && y.ch !== y.sal) {
    html += `<span class="guar-line partial">G: ${fmtS(y.ch)}</span>`;
  } else if (y.st === 'NOT G') {
    html += `<span class="guar-line non-g">G: ${y.ch ? fmtS(y.ch) : '$0'}</span>`;
  }

  return html;
}

function optTag(opt) {
  if (opt === 'TEAM OPT') return '<span class="tag tag-opt-to">Team Opt</span>';
  if (opt === 'PLAYER OPT') return '<span class="tag tag-opt-po">Player Opt</span>';
  return '';
}

function shortExc(exc) {
  return { 'Bird Exception':'Bird','Early Bird Exception':'Early Bird','Non-Bird Exception':'Non-Bird','Mid-Level Exception':'MLE','Taxpayer Mid-Level Exception':'Tax MLE','Room Mid-Level Exception':'Room MLE','Biannual Exception':'BAE','Minimum Salary Exception':'Minimum','Rookie Exception':'Rookie','Second Round Exception':'2nd Rnd' }[exc] || exc;
}

function shortNotes(notes) {
  const n = notes.replace(/Designated /g,'Des. ').replace(/Extension/g,'Ext.').replace(/Contract/g,'').replace(/Maximum /g,'Max ');
  return n.length > 30 ? n.slice(0,28) + 'â€¦' : n;
}

function extTag(ext) {
  const cls = {
    'eligible': 'tag-ext-elig',
    'future': 'tag-ext-date',
    'ineligible': 'tag-ext-inelig',
    'rookie': 'tag-ext-rookie',
    'extended': 'tag-ext-done',
    'na': 'tag-ext-na',
    'unknown': 'tag-ext-na',
  }[ext.status] || 'tag-ext-na';

  const title = ext.detail ? ` title="${ext.detail}"` : '';
  let html = `<span class="tag ${cls}"${title}>${ext.text}</span>`;
  if (ext.detail && (ext.status === 'eligible' || ext.status === 'future') && ext.detail.includes('Trade restriction')) {
    html += '<span class="ext-note">âš  traded</span>';
  }
  return html;
}

document.getElementById('searchBox').addEventListener('input', applyFilters);
document.getElementById('filterTeam').addEventListener('change', applyFilters);
document.getElementById('filterStatus').addEventListener('change', applyFilters);
document.getElementById('filterException').addEventListener('change', applyFilters);
document.getElementById('filterEnd').addEventListener('change', applyFilters);
document.getElementById('filterExt').addEventListener('change', applyFilters);

loadData();
</script>
</body>
</html>
